<!DOCTYPE html>
<html lang="en" ng-app="securityApp">
<head>
  <meta charset="UTF-8" />
  <title>Change Password</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <style>
    body {
      background: #f4f8fb;
    }
    .card {
      max-width: 420px;
      margin: auto;
      margin-top: 60px;
      border-radius: 15px;
    }
    h2 {
      text-align: center;
      font-weight: 600;
      color: #333;
    }
  </style>
</head>
<body ng-controller="SecurityController">
   
  <div class="card shadow p-4">
    <div class="d-flex justify-content-end">
  <label class="me-2 fw-bold text-primary">Close</label>
  <select class="form-select form-select-sm w-auto" onchange="if(this.value==='yes'){ window.location.href='mainpage_eshopping.html'; }">
    <option value="">Select</option>
    <option value="yes">Yes</option>
    <option value="no">No</option>
  </select>
</div>


    <h2>🔐 Change Password</h2>
    <form ng-submit="updatePassword()">
      <div class="form-group mb-3">
        <label>Email</label>
        <input type="email" class="form-control" ng-model="email" placeholder="Enter email" required />
      </div>
      <div class="form-group mb-3">
        <label>Current Password</label>
        <input type="password" class="form-control" ng-model="currentPassword" placeholder="Current password" required />
      </div>
      <div class="form-group mb-3">
        <label>New Password</label>
        <input type="password" class="form-control" ng-model="newPassword" placeholder="New password" required />
      </div>
      <div class="form-group mb-3">
        <label>Confirm Password</label>
        <input type="password" class="form-control" ng-model="confirmPassword" placeholder="Confirm new password" required />
      </div>
      <button class="btn btn-primary w-100">🔁 Update</button>
    </form>

    <!-- Messages -->
    <div class="alert alert-success mt-3" ng-if="successMessage">{{ successMessage }}</div>
    <div class="alert alert-danger mt-3" ng-if="errorMessage">{{ errorMessage }}</div>
  </div>

  <script>
  angular.module("securityApp", [])
    .controller("SecurityController", function ($scope, $http) {
      $scope.email = (localStorage.getItem("savedUserEmail") || "").trim().toLowerCase();

      $scope.updatePassword = function () {
        if ($scope.newPassword !== $scope.confirmPassword) {
          $scope.errorMessage = "❌ Passwords do not match!";
          $scope.successMessage = "";
          return;
        }

        const payload = {
          email: $scope.email.trim(),
          currentPassword: $scope.currentPassword,
          newPassword: $scope.newPassword
        };

        $http.put("http://localhost:8086/ecommerce/v1/change-password", payload)
          .then(function (response) {
            $scope.successMessage = typeof response.data === "string"
              ? response.data
              : (response.data.message || "✅ Password updated!");
            $scope.errorMessage = "";
            $scope.currentPassword = "";
            $scope.newPassword = "";
            $scope.confirmPassword = "";

            // ✅ Redirect after 1 second
            setTimeout(() => {
              window.location.href = "loginpage.html";
            }, 2000);
          })
          .catch(function (error) {
            if (error.status === 200 && typeof error.data === "string") {
              // Fallback: if Angular treats success as error
              $scope.successMessage = error.data;
              $scope.errorMessage = "";
              setTimeout(() => {
                window.location.href = "loginpage.html";
              }, 1000);
            } else {
              $scope.errorMessage = error.data?.message || error.data || "❌ Failed to update password.";
              $scope.successMessage = "";
            }
          });
      };
    });
</script>

</body>
</html>
