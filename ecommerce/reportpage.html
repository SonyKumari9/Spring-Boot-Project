<!DOCTYPE html>
<html ng-app="reportApp">
<head>
  <meta charset="UTF-8">
  <title>eShop Reports</title>

  <!-- Bootstrap & AngularJS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Export Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    .report-card { border-radius: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .chart-container { height: 300px; }
  </style>
</head>
<body ng-controller="reportController" class="bg-light">

  <div class="container py-4">
    <h2 class="mb-4 text-center">ðŸ“Š Reports Dashboard (Admin)</h2>

    <!-- Summary Cards -->
    <div class="row g-4 text-white">
      <div class="col-md-4">
        <div class="card bg-primary report-card">
          <div class="card-body">
            <h5>Today's Sales</h5>
            <h3>â‚¹{{summary.today}}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-success report-card">
          <div class="card-body">
            <h5>This Week</h5>
            <h3>â‚¹{{summary.week}}</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-warning report-card">
          <div class="card-body">
            <h5>This Month</h5>
            <h3>â‚¹{{summary.month}}</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row mt-5">
      <div class="col-md-6">
        <div class="card report-card p-3">
          <h5 class="text-center">Category-wise Sales</h5>
          <canvas id="categoryChart" class="chart-container"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card report-card p-3">
          <h5 class="text-center">Monthly Revenue</h5>
          <canvas id="revenueChart" class="chart-container"></canvas>
        </div>
      </div>
    </div>

    <br>

    <div><button class="btn btn-primary btn-sm me-1" onclick="window.location.href='dashboard.html'">Back to Dashboard</button></div>
    <!-- Top Products Table -->
    <div class="card mt-3 report-card">
      <div class="card-body">
        <h5 class="mb-3">ðŸ”¥ Top Selling Products</h5>

        <!-- Filter and Export Buttons -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <label class="form-label fw-bold">Date Filter:</label>
            <select class="form-select d-inline w-auto" ng-model="selectedFilter" ng-change="applyFilter()">
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="custom">Custom</option>
            </select>
            <input type="date" ng-show="selectedFilter === 'custom'" ng-model="customStart" class="form-control d-inline w-auto ms-2">
            <input type="date" ng-show="selectedFilter === 'custom'" ng-model="customEnd" class="form-control d-inline w-auto ms-2">
            <button class="btn btn-sm btn-secondary ms-2" ng-click="applyFilter()">Apply</button>
          </div>

          

          <div>
            <button class="btn btn-outline-success btn-sm me-2" ng-click="exportToExcel()">Export Excel</button>
            <button class="btn btn-outline-danger btn-sm" ng-click="exportToPDF()">Export PDF</button>
          </div>
        </div>

        <!-- Brand Filter -->
        <div class="mb-3">
          <label class="form-label fw-bold">Filter by Brand:</label>
          <select class="form-select w-auto d-inline" ng-model="selectedBrand" ng-options="b for b in getUniqueBrands()" ng-change="filterByBrand(selectedBrand)">
          </select>
        </div>

        <!-- Table -->
        <table class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>Product</th>
              <th>Brand</th>
              <th>Sold</th>
              <th>Revenue</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="p in getPaginatedProducts()">
              <td>{{p.name}}</td>
              <td>{{p.brand}}</td>
              <td>{{p.sold}}</td>
              <td>â‚¹{{p.revenue}}</td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="d-flex justify-content-center align-items-center">
          <button class="btn btn-outline-secondary btn-sm me-2" ng-click="prevPage()" ng-disabled="currentPage === 0">Previous</button>
          <span class="fw-bold">Page {{ currentPage + 1 }} of {{ totalPages() }}</span>
          <button class="btn btn-outline-secondary btn-sm ms-2" ng-click="nextPage()" ng-disabled="currentPage >= totalPages() - 1">Next</button>
        </div>

      </div>
    </div>
  </div>

  <!-- AngularJS Controller -->
  <script>
    var app = angular.module('reportApp', []);
    app.controller('reportController', function($scope, $http) {
      const apireportUrl = "http://localhost:8086/commerce/report/all";

      $scope.topProducts = [];
      $scope.filteredProducts = [];
      $scope.currentPage = 0;
      $scope.pageSize = 5;
      $scope.selectedBrand = 'all';

      $scope.totalPages = function () {
        return Math.ceil($scope.filteredProducts.length / $scope.pageSize);
      };

      $scope.getPaginatedProducts = function () {
        const start = $scope.currentPage * $scope.pageSize;
        return $scope.filteredProducts.slice(start, start + $scope.pageSize);
      };

      $scope.nextPage = function () {
        if ($scope.currentPage < $scope.totalPages() - 1) {
          $scope.currentPage++;
        }
      };

      $scope.prevPage = function () {
        if ($scope.currentPage > 0) {
          $scope.currentPage--;
        }
      };

      $scope.getUniqueBrands = function () {
        const brands = $scope.topProducts.map(p => p.brand);
        return ['all', ...new Set(brands)];
      };

      $scope.filterByBrand = function (brand) {
        $scope.currentPage = 0;
        if (brand === 'all') {
          $scope.filteredProducts = $scope.topProducts;
        } else {
          $scope.filteredProducts = $scope.topProducts.filter(p => p.brand === brand);
        }
      };

      $scope.applyFilter = function () {
        if ($scope.selectedFilter === 'custom') {
          if (!$scope.customStart || !$scope.customEnd) {
            alert("Please select both start and end date.");
          } else {
            alert("Showing data from " + $scope.customStart + " to " + $scope.customEnd);
          }
        } else {
          alert("Showing " + $scope.selectedFilter + "'s data.");
        }
      };

      $http.get(apireportUrl).then(function(response) {
        const dataList = response.data;

        if (dataList.length > 0) {
          $scope.summary = {
            today: dataList[0].today,
            week: dataList[0].week,
            month: dataList[0].month
          };

          $scope.topProducts = dataList.map(d => ({
            name: d.name,
            brand: d.brand,
            sold: d.sold,
            revenue: d.revenue
          }));

          $scope.filteredProducts = $scope.topProducts;
        }
      }, function(error) {
        console.error("Error fetching report data:", error);
        alert("Failed to load report data.");
      });

      $scope.exportToExcel = function () {
        const ws_data = [['Product', 'Brand', 'Sold', 'Revenue']];
        $scope.filteredProducts.forEach(p => {
          ws_data.push([p.name, p.brand, p.sold, p.revenue]);
        });
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'TopProducts');
        XLSX.writeFile(wb, 'TopSellingProducts.xlsx');
      };

      $scope.exportToPDF = function () {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text("Top Selling Products", 14, 20);

        let startY = 30;
        doc.setFontSize(10);
        doc.text("Product", 14, startY);
        doc.text("Brand", 64, startY);
        doc.text("Sold", 114, startY);
        doc.text("Revenue", 154, startY);

        $scope.filteredProducts.forEach((p, i) => {
          const y = startY + 10 + (i * 10);
          doc.text(p.name, 14, y);
          doc.text(p.brand, 64, y);
          doc.text(p.sold.toString(), 114, y);
          doc.text("â‚¹" + p.revenue, 154, y);
        });

        doc.save('TopSellingProducts.pdf');
      };

      // Static Charts
      new Chart(document.getElementById('categoryChart'), {
        type: 'pie',
        data: {
          labels: ['Electronics', 'Clothing', 'Home', 'Beauty'],
          datasets: [{
            data: [55, 25, 10, 10],
            backgroundColor: ['#0d6efd', '#20c997', '#ffc107', '#dc3545']
          }]
        }
      });

      new Chart(document.getElementById('revenueChart'), {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'Revenue (â‚¹)',
            data: [15000, 18000, 21000, 24000, 19000, 26000],
            borderColor: '#6610f2',
            backgroundColor: 'rgba(102, 16, 242, 0.1)',
            fill: true,
            tension: 0.4
          }]
        }
      });

    });
  </script>

</body>
</html>
