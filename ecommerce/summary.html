<!DOCTYPE html>
<html ng-app="summaryApp">
<head>
  <meta charset="UTF-8">
  <title>Product Summary</title>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .card { margin-top: 20px; }
    .related-product img {
      max-height: 150px;
      object-fit: cover;
      width: 100%;
    }
    .related-product { cursor: pointer; }
    .related-title { margin-top: 40px; margin-bottom: 15px; }
    .sidebar {
      border-right: 1px solid #ddd;
      padding-right: 20px;
    }
    .accordion-button {
      font-weight: 600;
    }
  </style>
</head>

<body ng-controller="SummaryController">
  <div class="container mt-4">
    <h3 class="mb-4 text-primary">Product Summary Page  
      <span><button class="btn btn-sm btn-primary" style="margin-left: 880px;" onclick="window.location.href='homepage.html'">
      Back
    </button></span></h3>
    

    <div class="row">
      <!-- Left Sidebar Filters -->
      <div class="col-md-3 sidebar">
        <div class="accordion" id="filterAccordion">

          <!-- Category Filter -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingCategory">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCategory">
                    Category
                  </button>
                </h2>
                <div id="collapseCategory" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                  <div class="accordion-body">
                    <div ng-repeat="c in filterData.categories">
                      <input type="checkbox"> {{c}}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Product Name Filter -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingName">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseName">
                    Product Name
                  </button>
                </h2>
                <div id="collapseName" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                  <div class="accordion-body">
                    <div ng-repeat="n in filterData.names">
                      <input type="checkbox"> {{n}}
                    </div>
                  </div>
                </div>
              </div>


          <!-- Size Filter -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingSize">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSize">
                Size
              </button>
            </h2>
            <div id="collapseSize" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
              <div class="accordion-body">
                <div ng-repeat="s in filterData.sizes">
                  <input type="checkbox"> {{s}}
                </div>
              </div>
            </div>
          </div>

          <!-- Brand Filter -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingBrand">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrand">
                Brand
              </button>
            </h2>
            <div id="collapseBrand" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
              <div class="accordion-body">
                <div ng-repeat="b in filterData.brands">
                  <input type="checkbox"> {{b}}
                </div>
              </div>
            </div>
          </div>

          <!-- Price Filter -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingPrice">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrice">
                Price
              </button>
            </h2>
            <div id="collapsePrice" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
              <div class="accordion-body">
                <div ng-repeat="p in filterData.prices">
                  <input type="checkbox"> ₹{{p}}
                </div>
              </div>
            </div>
          </div>

          <!-- Gender Filter -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingGender">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGender">
                Gender
              </button>
            </h2>
            <div id="collapseGender" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
              <div class="accordion-body">
                <div ng-repeat="g in filterData.genders">
                  <input type="checkbox"> {{g}}
                </div>
              </div>
            </div>
          </div>

          <!-- Latest Brand Filter -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingLatest">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLatest">
                Latest Brands
              </button>
            </h2>
            <div id="collapseLatest" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
              <div class="accordion-body">
                <div ng-repeat="l in filterData.letestbrands">
                  <input type="checkbox"> {{l}}
                </div>
              </div>
            </div>
          </div>

          <!-- Top Brand Filter -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingTopBrands">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTopBrands">
                Top Brands
              </button>
            </h2>
            <div id="collapseTopBrands" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
              <div class="accordion-body">
                <div ng-repeat="t in filterData.topbrands">
                  <input type="checkbox"> {{t}}
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Right Product Details -->
      <div class="col-md-9">
        <div ng-if="selectedProduct">
          <div class="card mb-4">
            <div class="row g-0">
              <div class="col-md-4">
                <img ng-src="{{selectedProduct.imageUrl}}" class="img-fluid rounded-start" alt="{{selectedProduct.name}}">
              </div>
              <div class="col-md-4">
                <div class="card-body">
                  <h5 class="card-title">{{selectedProduct.name}}</h5>
                  <p class="card-text">₹{{selectedProduct.price}}</p>
                  <p class="card-text">Brand: {{selectedProduct.brand || 'N/A'}}</p>
                  <p class="card-text">Size: {{selectedProduct.size || 'N/A'}}</p>
                  <p class="card-text text-success">Discount: {{selectedProduct.discount || '0'}}%</p>
                </div>
              </div>
              <div class="col-md-4">
                <p><strong>Instruction:</strong> {{selectedProduct.instruction || 'N/A'}}</p>
                <p><strong>Model:</strong> {{selectedProduct.modelName || 'N/A'}}</p>
                <p><strong>Quantity:</strong> {{selectedProduct.quantity || 'N/A'}}</p>
                <p><strong>Idea For:</strong> {{selectedProduct.ideaFor || 'N/A'}}</p>
                <p><strong>Application Area:</strong> {{selectedProduct.applicationArea || 'N/A'}}</p>
                <p><strong>Applied For:</strong> {{selectedProduct.appliedFor || 'N/A'}}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Similar Products -->
        <div ng-if="similarProducts.length > 1">
          <h5 class="text-secondary related-title">Similar Products</h5>
          <div class="row">
            <div class="col-md-3" ng-repeat="p in similarProducts" ng-if="p.id !== selectedProduct.id">
              <div class="card related-product h-100" ng-click="setProduct(p)">
                <img ng-src="{{p.imageUrl}}" class="card-img-top" alt="{{p.name}}">
                <div class="card-body">
                  <h6 class="card-title">{{p.name}}</h6>
                  <p class="card-text">₹{{p.price}}</p>
                  <p class="card-text small text-muted">{{p.brand}} | Size: {{p.size}}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- No Selection Message -->
        <div ng-if="!selectedProduct && similarProducts.length === 0">
          <div class="alert alert-warning mt-4">
            No product selected. Please go back and click <strong>"Summary to Show"</strong>.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AngularJS Script -->
  <script>
  var app = angular.module("summaryApp", []);

  app.controller("SummaryController", function($scope, $http) {
    $scope.selectedProduct = null;
    $scope.products = [];
    $scope.similarProducts = [];

    $scope.filterData = {
      sizes: [],
      brands: [],
      prices: [],
      genders: [],
      topbrands: [],
      letestbrands: []
    };

    // Load selected product from localStorage
    const stored = localStorage.getItem("selectedProduct");
    if (stored) {
      $scope.selectedProduct = JSON.parse(stored);
    }

    // Load all products from backend
    $http.get("http://localhost:8086/ecommerce/search?query=").then(function(response) {
      const allProducts = response.data;

      // Group products by unique price (Flipkart style)
      const grouped = [];
      const seenPrices = new Set();

      for (const p of allProducts) {
        if (!seenPrices.has(p.price)) {
          seenPrices.add(p.price);
          grouped.push(p); // Add only one product per price
        }
      }

      $scope.products = allProducts;           // full product list
      $scope.similarProducts = grouped;        // unique price products

      filterExactMatch(); // Optional: for initial filtering
    });

    // Load filter values from brandfilters table
    $http.get("http://localhost:8086/ecommerce/brandfilters/all").then(function(response) {
      const data = response.data;
      $scope.filterData.sizes = [...new Set(data.map(item => item.size))].filter(Boolean);
      $scope.filterData.brands = [...new Set(data.map(item => item.brandname))].filter(Boolean);
      $scope.filterData.prices = [...new Set(data.map(item => item.price))].filter(Boolean);
      $scope.filterData.genders = [...new Set(data.map(item => item.gender))].filter(Boolean);
      $scope.filterData.topbrands = [...new Set(data.map(item => item.topbrandname))].filter(Boolean);
      $scope.filterData.letestbrands = [...new Set(data.map(item => item.letestbrandname))].filter(Boolean);
      $scope.filterData.categories = [...new Set(data.map(item => item.category))].filter(Boolean);
      $scope.filterData.names = [...new Set(data.map(item => item.name))].filter(Boolean);

    });

    // Change selected product and scroll
    $scope.setProduct = function(product) {
      $scope.selectedProduct = product;
      localStorage.setItem("selectedProduct", JSON.stringify(product));
      filterExactMatch();
      window.scrollTo(0, 0);
    };

    // Optional: Show only products exactly matching selectedProduct
    function filterExactMatch() {
      if (!$scope.selectedProduct) return;
      const ref = $scope.selectedProduct;
      $scope.similarProducts = $scope.products.filter(p =>
        p.name === ref.name &&
        p.brand === ref.brand &&
        p.price === ref.price &&
        p.size === ref.size
      );
    }
  });
</script>

</body>
</html>
