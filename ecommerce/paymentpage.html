<!DOCTYPE html>
<html lang="en" ng-app="paymentApp">
<head>
  <meta charset="UTF-8">
  <title>Order Payment Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>



  <style>
    body {
      background: #f1f3f6;
      font-family: 'Segoe UI', sans-serif;
    }
    .payment-dashboard {
      max-width: 1200px;
      margin: 40px auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }
    .dashboard-header {
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
      padding-bottom: 10px;
    }
    .dashboard-header h2 {
      color: #343a40;
    }
    .table thead {
      background-color: #007bff;
      color: white;
      font-size: 14px;
    }
    .table td, .table th {
      vertical-align: middle;
      font-size: 14px;
    }
    .badge-status {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
    }
    .paid { background-color: #c8e6c9; color: #256029; }
    .pending { background-color: #ffe082; color: #8a6d3b; }
    .failed { background-color: #ffcdd2; color: #c62828; }
    .pagination {
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>
<body ng-controller="PaymentController">

  <div class="payment-dashboard">
    <div class="dashboard-header d-flex justify-content-between align-items-center">

              <div class="d-flex justify-content-end">
          <label class="me-2 fw-bold text-primary">Close</label>
          <select class="form-select form-select-sm w-auto" onchange="
            if(this.value === 'yes') {
              window.location.href = 'settings.html';
            } else if(this.value === 'no') {
              window.location.href = 'dashboard.html';
            }
          ">
            <option value="">Select</option>
            <option value="yes">Go Setting</option>
            <option value="no">Dashboard</option>
          </select>
        </div>

      <h2>üí≥ Payment Status</h2>
      <span class="text-muted">Showing recent orders
        <!-- <small style="margin-right: 30px; color: #1e08e1; font-weight: bold;"   onclick="window.location.href='dashboard.html'">Close</small> -->
      </span>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4 text-center">
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-white" style="background: linear-gradient(to right, #4facfe, #00f2fe); border-radius: 10px;">
            <h6>Total Orders</h6>
            <h4>{{ filteredOrders().length }}</h4>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-white" style="background: linear-gradient(to right, #43e97b, #38f9d7); border-radius: 10px;">
            <h6>Total Revenue</h6>
            <h4>‚Çπ{{ getTotalRevenue() }}</h4>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body text-white" style="background: linear-gradient(to right, #f093fb, #f5576c); border-radius: 10px;">
            <h6>Delivered</h6>
            <h4>{{ getDeliveredCount() }}</h4>
          </div>
        </div>
      </div>
    </div>
    

    <!-- Search -->
    <div class="mb-3 d-flex justify-content-end">
      <input type="text" class="form-control w-25" placeholder="Search by name/product..." ng-model="searchText">
    </div>

    <!-- üìÖ Date Filter + üìä Chart -->
    <div class="row mb-4 align-items-center">
      <div class="col-md-4">
        <label>From:</label>
        <input type="date" class="form-control" ng-model="filterStartDate">
      </div>
      <div class="col-md-4">
        <label>To:</label>
        <input type="date" class="form-control" ng-model="filterEndDate">
      </div>
      <div class="col-md-4 mt-3 mt-md-0">
        <canvas id="paymentChart" height="150"></canvas>
      </div>
    </div>

    <button class="btn btn-sm btn-outline-primary mb-3" data-bs-toggle="modal" data-bs-target="#paymentOptionModal">
      Add / Update Payment Option
    </button>


    <!-- üßæ Add / Update Payment Option Modal -->
<div class="modal fade" id="paymentOptionModal" tabindex="-1" aria-labelledby="paymentOptionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="paymentOptionModalLabel">Add or Update Payment Option</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form ng-submit="submitPaymentOption()">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Customer Name</label>
            <input type="text" class="form-control" ng-model="newPayment.name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Payment Mode</label>
            <select class="form-select" ng-model="newPayment.mode" required>
              <option value="">Select</option>
              <option value="Credit Card">Credit Card</option>
              <option value="Debit Card">Debit Card</option>
              <option value="UPI">UPI</option>
              <option value="Net Banking">Net Banking</option>
              <option value="Cash on Delivery">Cash on Delivery</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Amount</label>
            <input type="number" class="form-control" ng-model="newPayment.amount" required>
          </div>
          <div class="mb-3" ng-if="newPayment.mode !== 'Cash on Delivery'">
            <label class="form-label">Card / UPI / Bank Info</label>
            <input type="text" class="form-control" ng-model="newPayment.details" placeholder="XXXX-XXXX-XXXX / UPI ID">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">üíæ Save Payment</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>


    

    <!-- Table -->
    <table class="table table-bordered table-hover table-sm text-center">
      <thead>
        <tr>
          <th>#</th>
          <th>Order ID</th>
          <th>Name</th>
          <th>Product</th>
          <th>Brand / Size</th>
          <th>Price</th>
          <th>Delivery</th>
          <th>Discount</th>
          <th>Total</th>
          <th>Status</th>
          <th>Payment</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="order in paginatedOrders()">
          <td>{{$index + 1 + (currentPage - 1) * itemsPerPage}}</td>
          <td>{{ order.orderId }}</td>
          <td>{{ order.name }}</td>
          <td>{{ order.product }}</td>
          <td>{{ order.brand }} / {{ order.size }}</td>
          <td>‚Çπ{{ order.price }}</td>
          <td>‚Çπ{{ order.deliveryCharge }}</td>
          <td>‚Çπ{{ order.discount }}</td>
          <td><strong>‚Çπ{{ order.finalTotal }}</strong></td>
          <td>
            <span class="badge-status"
              ng-class="{
                'paid': order.status_delivered,
                'pending': order.status_orderd && !order.status_delivered,
                'failed': !order.status_delivered && !order.status_orderd
              }">
              {{ order.status_delivered ? 'Delivered' : (order.status_orderd ? 'Ordered' : 'Pending') }}
            </span>
          </td>
          <td>{{ order.payment }}</td>
          <td>{{ order.orderDate }}</td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <nav>
      <ul class="pagination">
        <li class="page-item" ng-class="{disabled: currentPage === 1}">
          <a class="page-link" href="#" ng-click="prevPage()">‚èÆ</a>
        </li>
        <li class="page-item" ng-repeat="n in pageNumbers()" ng-class="{active: currentPage === n}">
          <a class="page-link" href="#" ng-click="setPage(n)">{{n}}</a>
        </li>
        <li class="page-item" ng-class="{disabled: currentPage === totalPages()}">
          <a class="page-link" href="#" ng-click="nextPage()">‚è≠</a>
        </li>
      </ul>
    </nav>
  </div>

  <footer class="text-center mt-4 text-muted">
    Updated: {{ (orders.length > 0) ? (orders[0].orderDate || 'N/A') : 'No orders yet.' }}
  </footer>

  <script>
    angular.module('paymentApp', [])
      .controller('PaymentController', function ($scope, $http, $timeout) {
        $scope.orders = [];
        $scope.currentPage = 1;
        $scope.itemsPerPage = 5;
        $scope.searchText = "";

        $http.get("http://localhost:8086/orderlocation/v5/all")
          .then(function (response) {
            $scope.orders = response.data;
            $timeout(drawPaymentChart, 300);  // Wait until data is loaded
          })
          .catch(function (error) {
            console.error("Error loading order data:", error);
          });

        $scope.$watchGroup(['searchText', 'filterStartDate', 'filterEndDate'], function () {
          drawPaymentChart();
        });

        $scope.getTotalRevenue = function () {
          return $scope.filteredOrders().reduce((sum, order) => {
            return sum + (parseFloat(order.finalTotal || 0) || 0);
          }, 0).toFixed(2);
        };

        $scope.getDeliveredCount = function () {
          return $scope.filteredOrders().filter(o => o.status_delivered).length;
        };

        $scope.filteredOrders = function () {
          return $scope.orders.filter(order => {
            const nameMatch = (order.name && order.name.toLowerCase().includes($scope.searchText.toLowerCase())) ||
                              (order.product && order.product.toLowerCase().includes($scope.searchText.toLowerCase()));
            const orderDate = new Date(order.orderDate);
            const startDate = $scope.filterStartDate ? new Date($scope.filterStartDate) : null;
            const endDate = $scope.filterEndDate ? new Date($scope.filterEndDate) : null;
            const dateInRange = (!startDate || orderDate >= startDate) &&
                                (!endDate || orderDate <= endDate);
            return nameMatch && dateInRange;
          });
        };

        $scope.totalPages = function () {
          return Math.ceil($scope.filteredOrders().length / $scope.itemsPerPage);
        };

        $scope.pageNumbers = function () {
          return Array.from({ length: $scope.totalPages() }, (_, i) => i + 1);
        };

        $scope.setPage = function (n) {
          $scope.currentPage = n;
        };

        $scope.prevPage = function () {
          if ($scope.currentPage > 1) $scope.currentPage--;
        };

        $scope.nextPage = function () {
          if ($scope.currentPage < $scope.totalPages()) $scope.currentPage++;
        };

        $scope.paginatedOrders = function () {
          const start = ($scope.currentPage - 1) * $scope.itemsPerPage;
          return $scope.filteredOrders().slice(start, start + $scope.itemsPerPage);
        };

        $scope.newPayment = {};

$scope.submitPaymentOption = function () {
  if (!$scope.newPayment.name || !$scope.newPayment.mode || !$scope.newPayment.amount) {
    alert("Please fill all required fields.");
    return;
  }
  console.log("Submitted Payment Option:", $scope.newPayment);
  alert("Payment option saved successfully!");
  // TODO: Call backend API here
  $scope.newPayment = {};
  var modal = bootstrap.Modal.getInstance(document.getElementById('paymentOptionModal'));
  modal.hide();
};


        function drawPaymentChart() {
          const paymentCounts = {};
          $scope.filteredOrders().forEach(order => {
            const type = order.payment || "Unknown";
            paymentCounts[type] = (paymentCounts[type] || 0) + 1;
          });

          const labels = Object.keys(paymentCounts);
          const data = Object.values(paymentCounts);

          const ctx = document.getElementById("paymentChart").getContext("2d");
          if (window.paymentPieChart) {
            window.paymentPieChart.destroy();
          }

          window.paymentPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: ['#4facfe', '#43e97b', '#f093fb', '#ffdd59', '#ff6b6b']
              }]
            },
            options: {
              plugins: {
                legend: { position: 'bottom' },
                datalabels: {
                  color: '#fff',
                  formatter: value => value
                }
              }
            },
            plugins: [ChartDataLabels]
          });
        }
      });
  </script>
</body>
</html>
