<!DOCTYPE html>
<html ng-app="mailApp">
<head>
  <meta charset="UTF-8">
  <title>eShop | Mail</title>

  <!-- AngularJS -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background: linear-gradient(to right, #f8f9fa, #e2e6ea);
      font-family: 'Segoe UI', sans-serif;
    }

    .mail-container {
      max-width: 700px;
      margin: 60px auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .mail-body {
      height: 120px;
      resize: none;
    }

    .mail-list {
      background: #f8f9fa;
      padding: 15px;
      max-height: 250px;
      overflow-y: auto;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .mail-message {
      background: #eef3f9;
      border-left: 4px solid #0d6efd;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 12px;
    }

    .toast-container {
      z-index: 1055;
    }
  </style>
</head>

<body ng-controller="MailController">
  
  <!-- Header -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light px-4">
    <a class="navbar-brand fw-bold text-primary" href="#">eShop</a>

    <!-- Search -->
    <form class="d-flex mx-auto" style="width: 50%;" ng-submit="search()">
      <!-- <input class="form-control me-2" type="search" placeholder="Search for products" ng-model="searchText"> -->
      <!-- <button class="btn btn-outline-primary" type="submit">Search</button> -->
    </form>

    <div>
      <button class="btn btn-outline-success">
        <a href="mainpage_eshopping.html" class="text-decoration-none text-success">Back App</a>
      </button>
      
      
    </div>
  </nav>

  <div class="mail-container">
    <h4 class="text-center mb-4 text-primary">üìß Send Mail - eShopping</h4>

    <!-- Mobile Number -->
    <div class="mb-3">
      <label class="form-label">üì± Mobile Number</label>
      <input type="tel" class="form-control"
             ng-model="mobile"
             placeholder="Enter 10-digit mobile number"
             maxlength="10"
             required>
      <div class="form-text text-danger" ng-show="mobile && !isValidMobile()">
        Please enter a valid 10-digit mobile number starting with 6-9.
      </div>
    </div>

    <!-- Message Input -->
    <div class="mb-3">
      <label class="form-label">‚úâÔ∏è Write Message</label>
      <textarea class="form-control mail-body" ng-model="newMessage"
                placeholder="Type your message here..."></textarea>
    </div>

    <div class="mb-3 d-flex gap-2">
      <button class="btn btn-secondary" ng-click="addMessage()"
              ng-disabled="!newMessage || !isValidMobile()">
        <i class="bi bi-plus-circle"></i> Add to Mail
      </button>
    </div>

    <!-- Message List -->
    <div class="mail-list" ng-if="messages.length > 0">
      <div class="mail-message" ng-repeat="msg in messages track by $index">
        <strong>Message {{ $index + 1 }}</strong>
        <p class="mb-0">{{ msg.content }}</p>
      </div>
    </div>

    <!-- Email ID -->
    <div class="mb-3">
      <label class="form-label">üìß Mail ID</label>
      <input type="email" class="form-control"
             ng-model="mailid"
             placeholder="Enter email"
             ng-disabled="messages.length === 0">
      <div class="form-text text-danger" ng-show="mailid && !isValidEmail()">
        Please enter a valid email address.
      </div>
    </div>

    <!-- Send All Button -->
    <div class="d-flex gap-2">
      <button class="btn btn-success"
              ng-click="sendAll()"
              ng-disabled="messages.length === 0 || !isValidMobile() || !isValidEmail()">
        <i class="bi bi-send-check-fill"></i> Send All
      </button>
    </div>
  </div>

  <!-- Success Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div class="toast align-items-center text-bg-success border-0" id="successToast">
      <div class="d-flex">
        <div class="toast-body">
          ‚úÖ Mail sent successfully!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>

    <!-- Error Toast -->
    <div class="toast align-items-center text-bg-danger border-0" id="errorToast">
      <div class="d-flex">
        <div class="toast-body">
          ‚ùå Failed to send mail.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- AngularJS Script -->
  <script>
    const app = angular.module('mailApp', []);

    app.controller('MailController', function ($scope, $http) {
      $scope.newMessage = '';
      $scope.messages = [];
      $scope.mobile = '';
      $scope.mailid = '';

      // Mobile validation
      $scope.isValidMobile = function () {
        return /^[6-9]\d{9}$/.test($scope.mobile);
      };

      // Email validation
      $scope.isValidEmail = function () {
        return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test($scope.mailid);
      };

      // Add message to list
      $scope.addMessage = function () {
        const trimmed = $scope.newMessage.trim();
        if (trimmed && $scope.isValidMobile()) {
          $scope.messages.push({ content: trimmed });
          $scope.newMessage = '';
        } else {
          alert("Please enter a valid message and mobile number.");
        }
      };

      // Send all messages
      $scope.sendAll = function () {
        const fullContent = $scope.messages.map(m => m.content).join('\n\n');
        const payload = {
          mobile: $scope.mobile,
          content: fullContent,
          mailid: $scope.mailid
        };

        $http.post('http://localhost:8086/mailsend/v4/mail', payload)
          .then(function () {
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
            $scope.messages = [];
            $scope.mobile = '';
            $scope.mailid = '';
          }, function (error) {
            const toast = new bootstrap.Toast(document.getElementById('errorToast'));
            toast.show();
            console.error("Mail send failed:", error);
          });
      };
    });
  </script>
</body>
</html>
